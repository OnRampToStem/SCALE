<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>S C A L E &nbsp;Course Editor</title>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
	<script src="lib/jquery.ui.touch-punch.min.js"></script>
	<script src="doc.js"></script>
	<script src="rules.js"></script>
	<script src="ckeditor/ckeditor.js"></script>
 	<style type="text/css">
		 body { 			font-family: Verdana,Geneva,sans-serif; font-size:14px; padding:0; margin:0; box-sizing: border-box;	}
		.wm-main { 			width:100%; height:calc(100vh - 4px); overflow:auto; background-color: #eee; display:none; min-width:1450px;
							}
		.wm-nav {	 		float:left; overflow:hidden; padding:24px; width: calc(100vw - 1075px); min-width:360px; 
							}
		.wm-confirm {		position: absolute;  width: 300px; padding: 16px; left: calc(50% - 150px); top: calc(50% - 50px); user-select: none;	
							border-radius: 8px; background-color: #fff; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							}
		.wm-content {		width:1000px; overflow:hidden; float:right; margin-right:24px; 
							}
		.wm-splash { 		width:100%; color:#999; text-align:center; margin-top:10%; display:none;
							}
		.wm-header { 		background-color: #bbb; width:100%; color:#fff;	padding: 8px 0px;
							}
		.wm-logo { 			height:30px; vertical-align: top; margin:0px 16px; cursor:pointer;
							}
		.wm-courseTitle { 	font-size: 24px; font-weight: bold; margin-right:32px; cursor:pointer;
							}
		.wm-pageTitle {		color:#333;	font-size: 24px; text-align:center; font-weight: bold; padding-top:16px; padding-bottom:8px;
							}
		.wm-stepEditor {	width:525px; overflow:hidden; margin:24px; background-color: #fff; border: 1px solid #999;
							padding:32px; border-radius: 16px;
							}
		.wm-popup {			position: absolute;  width: auto; padding: 12px; left: calc(50% - 100px); top: calc(50% - 50px);
							border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							text-align:center; display: none;
							}
		.wm-is {			border-radius:10px; padding-left:8px; padding-right:8px; padding-top:1px;
							border:1px solid #999; font-size:12px; height:20px; width:300px;
							}
		.wm-bs {			border-radius: 16px; padding-left: 8px; padding-right: 8px; display: inline-block; height: 17px; padding-top: 1px;
							font-size: 12px; background-color: #27ae5fb2; cursor: pointer; text-align: center; color:#fff; user-select: none;
							}
		.wm-tree {      	user-select: none; width: 100%; margin-left:40px;
							padding: 0px 0; font-size: 14px; text-align: left; 
							}

		.wm-tree ul { 		list-style: none outside none; padding: 0 }
		.wm-tree li a { 	line-height: 20px; cursor: pointer; }
		.wm-tree > ul > li > a { color:#000; display: block;  font-weight: normal; position: relative; text-decoration: none; }
		.wm-tree li.parent > a { padding: 0 0 0 16px;  }
		.wm-tree li.parent > a:before { background-image: url("img/treebuts.gif"); content: ""; display: block;
										height: 11px; left: 0; position: absolute; top: 4px; width: 11px;  background-position: 0px;
										}
		.wm-tree ul li.active > a:before { background-position: 22px; }
		.wm-tree ul li ul 	{ border-left: 1px solid #ccc;  display: none; margin: 0 0 0 5px; padding: 0 0 0 10px; }
		.wm-tree ul li ul li { position: relative; }

	</style>

</head>
<body>

	<div id='mainDiv' class='wm-main'>
		<div id='headerDiv' class='wm-header'>
			<img src='img/scaleLogoWhite.png' class='wm-logo'>
				<span id='courseTitle' class='wm-courseTitle'>Course</span>
				<span id='menuMsg' style='display:none;margin-left:32px'></span>
				<img id='showgdoc' style='cursor:pointer;float:right;margin-right:8px' src='img/gdrive.png'>
			</div>
		<div id='navDiv' class='wm-nav'></div>
		<div class='wm-content'>
			<div id='contentDiv'></div>
			<div id='editorDiv'>
				<textarea class='ckeditor' id='editor1' name='editor1'></textarea>
				<br><div style='float:right'>id: <input class='wm-is' type='text' style='width:60px;height:15px;text-align:center' id='paneId'></div>
				<div style='margin-left:470px'>
					<div id='savePaneBut' class='wm-bs'>Save changes</div>&nbsp;&nbsp;
					<img id='removePaneBut' style='vertical-align:-5px' src='img/trashbut.gif'>	
				</div>
				<div style='float:right' id='paneId'></div>
			</div>
		</div>
	</div>
	<div id='splashDiv' class='wm-splash'>
		<img src='img/scaleLogo.png'><br><br>
		<h1 style='font-size:18pt;font-family:trebuchet ms,sans-serif'><p></p>S C A L E &nbsp;Editor</p>Student-Centered Adaptive Learning Environment</h1>
		<p style='font-weight:bold;font-size:48px'><b>Course editor</p>
	</div>
		
<script>

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																

	constructor(id)   															// CONSTRUCTOR
	{
		app=this;
		this.doc=new Doc(id);														// Alloc doc w/ course id
		this.rul=new Rules();														// Rules
		this.con=new Content();														// Alloc content
		this.Draw(); 																// Draw app
		this.tree=null;																// Holds lobs tree
	}

	Draw() 																		// REDRAW
	{
		this.doc.Draw();															// Reset various params
		this.con.Draw();															// Reset various params
		DrawNav();																	// Draw navigation
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// INIT
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	var app=null;																// Hold course data 

	$(document).ready(function() {												// WHEN PAGE LOADED
		if (window.addEventListener) 												// If supported this way
			window.addEventListener("message",eventHandler,false);					// Add event handler
		else																		// Use other method
			window.attachEvent("message",eventHandler);								// Add handler

	var h=$(window).height()-300;													// Editor height
	if (window.location.host != "localhost") {										// Not in debug
		$("#splashDiv").fadeIn().delay(2000).fadeOut();								// Fade out splash
		$("#mainDiv").delay(2000).fadeIn(2000);										// Wait, and fade in main
		}	
	else																			// Debug
		$("#mainDiv").fadeIn(0),h+=44;												// Load fast (account for CK sizing bug)
	
	var url=window.location.search.substring(1);						   			// Get query string
	if (!url)	url="1qj6dQCS0DDR8VLHm9qpRYsS2NXtQ_7zmS2x5kMIp7Z4";					// If id set, use it
	app=new App(url);																// Alloc doc w/ course id
	CKEDITOR.on('instanceLoaded', function(e) { e.editor.resize("100%", h)});		// Resize editor

	$("#showgdoc").on("click",function() {											// Show google doc
		window.open("https://docs.google.com/spreadsheets/d/"+app.doc.courseId,"_blank");	// Show it	
		});
	
	$(window).on("keydown",function(e) {											// HANDLE KEYPRESS
		if ((e.which == 84) && e.altKey && e.ctrlKey) {								// Test key (Ctrl+Alt+T)
			app.tree.Open(30);																		
			}
		});

	});

	function eventHandler(e)													// ON HTML5 EVENT
	{
		if (e.data && e.data.match(/INS:/))	{										// Insert macro
			CKEDITOR.instances.editor1.insertText(e.data.substring(4));				// Insert text	
			Sound("ding");															// Ding	
			}
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// NAVIGATION
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	
	function DrawNav()															// DRAW COURSE NAVIGATION
	{
		var i,o;
		if (app.doc.lobs.length < 2)	return;										// Quit if not loaded yet
		$("#courseTitle").html(app.doc.lobs[0].name);								// Show course name
		var str="<b>Learning panes:</b><i> (Click to edit)</i>)<br>";				// Tree label
		str+="<div id='treeDiv' class='wm-tree'></div>";							// Add div to hold tree
		str+="<div id='addPaneBut' class='wm-bs'>Add new pane</div>&nbsp;&nbsp;";	// Add button
		str+="<br><br><hr><br><table class='wm-navTable'>";							// Line and table
		str+="<tr><td><b>Floats&nbsp;</b></td><td>"+MakeSelect("floatsBut",false,["Choose"])+"</td><td>&nbsp;<div id='addFloatBut' class='wm-bs'>Add</div></td>";
		str+="<tr><td><b>Questions&nbsp;</b></td><td>"+MakeSelect("asksBut",false,["Choose"])+"</td><td>&nbsp;<div id='addAskBut' class='wm-bs'>Add</div></td>";
		str+="<tr><td><b>Rules&nbsp;</b></td><td>"+MakeSelect("rulesBut",false,["Choose"])+"</td><td>&nbsp;<div id='addRuleBut'  class='wm-bs'>Add</div></td>";
		str+="</table>";
		str+="<br><hr><br><div id='saveCourseBut' class='wm-bs'>Save course</div>&nbsp;&nbsp;&nbsp;";
		str+="<div id='previewBut' class='wm-bs'>Preview course</div>&nbsp;&nbsp;&nbsp;";
		str+="<div id='undoBut' class='wm-bs'>Undo</div>&nbsp;&nbsp;&nbsp;";
		$("#navDiv").html(str);														// Draw nav part
		app.tree=new Tree();														// Show lobs tree				
		app.doc.SetCurVars(2);														// Set current areas																								
		for (i=0;i<app.rul.rules.length;++i) {										// For each rule
			o=app.rul.rules[i];														// Point at rule
			$("#rulesBut").append("<option value='"+o.id+"'>"+o.id+" - "+o.name+"</option>");	// Add to pulldown
			}
		for (i=0;i<app.doc.asks.length;++i) {										// For each ask
			o=app.doc.asks[i];														// Point at ask
			$("#asksBut").append("<option value='"+o.id+"'>"+o.id+" - "+o.name+"</option>");	// Add to pulldown
			}
		for (i=0;i<app.doc.floats.length;++i) {										// For each float
			o=app.doc.FindLobById(app.doc.floats[i]);								// Point at float lob
			if (o)																	// If valid
				$("#floatsBut").append("<option value='"+o.id+"'>"+o.id+" - "+o.name+"</option>");	// Add to pulldown
			}

		$("#asksBut").on("change", function() {  									// Edit ask
			app.con.Draw("ask",$(this)[0].selectedIndex-1);							// Show pane
			Sound("click"); 														// Click
			});

		$("#addPaneBut").on("click", ()=> {  										// Add new pane
			app.doc.AddNewLob(app.tree.curPaneId); 									// Add lob
			app.tree.Init(app.doc.lobs[app.doc.lobs.length-1].id);					// Remake tree
			Sound("ding"); 															// Ding
			});

		$("#floatsBut").on("change", function() {  									// Edit float
			o=app.doc.FindLobById($(this).val());									// Point at float lob
			if (o)	app.con.Draw("pane",o.id);										// Show float pane if valid
			Sound("click"); 														// Click
			});

		$("#addFloatBut").on("click", ()=> {  										// Add new floating pane
			app.doc.AddNewLob("float");			 									// Add lob
			var id=app.doc.lobs[app.doc.lobs.length-1].id;							// Get id
			app.doc.floats.push(id);												// Add to floats
			$("#floatsBut").append("<option value='"+id+"'>"+id+" - Rename this</option>");	// Add to pulldown
			$("#floatsBut")[0].selectedIndex=app.doc.floats.length;					// Select it
			app.con.Draw("pane",id);												// Edit new float
			Sound("ding"); 															// Ding
			});

		$("#addAskBut").on("click", ()=> { 											// ON ADD QUESTION
			var o={id:"000", name:"Change this!", step:"{\"optionType\":\"radio\",\"options\":[]}"};	// Step
			app.doc.asks.push(o);													// Add to asks
			$("#asksBut").append("<option>000 - Change this!</option>");			// Add option
			$("#asksBut")[0].selectedIndex=app.doc.asks.length-1;					// Select it
			app.con.Draw("ask",app.doc.asks.length-1);								// Show editor																							
			Sound("ding");															// Ding sound
			});

		$("#rulesBut").on("change", function() {  									// Edit ask
			app.con.Draw("rule",$(this)[0].selectedIndex-1);						// Show pane
			Sound("click"); 														// Click
			});
		
		$("#addRuleBut").on("click", ()=> { 										// ON ADD RULE
			var o={id:"000", name:"Change this!", verb:"=", do:"show"};				// Rule
			app.rul.rules.push(o);													// Add to rules
			$("#rulesBut").append("<option>000 - Change this!</option>");			// Add option
			$("#rulesBut")[0].selectedIndex=app.rul.rules.length-1;					// Select it
			app.con.Draw("rule",app.rul.rules.length-1);							// Show editor																							
			Sound("ding");															// Ding sound
			});



	}	

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// CONTENT
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	class Content {

		constructor()  																	// CONSTRUCTOR
		{
			this.curEditId=0;																// Id of current pane
			this.Draw("splash");															// Draw content

			$("#savePaneBut").on("click", ()=> {											// ON SAVE CHANGES
				var o=app.doc.lobs[this.curEditId];											// Point at lob
				o.body=CKEDITOR.instances.editor1.getData();								// Get body
				o.name=$("#pageTitle").text();												// Get name
				var id=$("#paneId").val();													// Get current id value
				if (id != o.id) {															// Reset
					app.doc.RenameLobId(o.id,id);											// Rename lob id
					app.tree.Init(id);														// Remake tree
					}
				else																		// Same id
					$("#tr-"+o.id).text(o.name)                             				// Reset tree name
				if (o.parent && o.parent.match(/float/i)) {									// A floating lob
					$('#floatsBut').find(":selected").text(o.id+" - "+o.name);				// Rename pulldown			
					$('#floatsBut').find(":selected").val(o.id);							// Rename pulldown value		
					$("#floatsBut")[0].selectedIndex=0;										// Clear selection
					this.Draw("splash");													// Draw splash
					}
				Sound("ding");																// Ding
				});

			$("#removePaneBut").on("click", ()=> {  										// ON REMOVE PANE
				ConfirmBox("Are you sure?", "This will remove any underlying panes!",()=> { // If sure
					var o=app.doc.lobs[this.curEditId];										// Point at lob
					if (o.parent && o.parent.match(/float/i)) {								// A floating lob
						app.doc.floats.splice($("#floatsBut")[0].selectedIndex,1);			// Remove from array
						$('#floatsBut').find(":selected").remove();							// Remove from pulldown			
						$("#floatsBut")[0].selectedIndex=0;									// Clear selection
						}
					app.doc.UnlinkLob(app.tree.curPaneId) 									// Remove it
					app.tree.Init();														// Remake tree
					this.Draw("splash");													// Draw splash
					Sound("delete");														// Delete sound
					});
			});

		}

		Draw(type, id)																	// DRAW
		{
			var o;
			var str="";
			$("#editorDiv").hide();															// Hide editor
			if (type == "splash") {															// Draw splash
				str+="<div style='text-align:center;color:#666'><br><br><br><br><br>";
				str+="<img src='img/scaleLogo.png'><br>";
				str+="<h1 style='font-size:24pt;font-family:trebuchet ms,sans-serif'><p></p>S C A L E</h1>";
				$("#contentDiv").html(str);													// Add splash
				}
			else if (type == "pane") {														// Draw pane
				id=app.doc.FindLobIndexById(id);											// Get index from id
				o=app.doc.lobs[id];															// Point at lob
				if (!o) { 																	// Invalid pane
					this.Draw("splash");													// Show splash																								
					return;																	// Quit
					}
				str+=o.name ? "<div id='pageTitle' class='wm-pageTitle' contentEditable='true'> "+o.name+"</div>" : "";			// Get page title
				$("#contentDiv").html(str);													// Add page title
				CKEDITOR.instances.editor1.setData(o.body);									// Add body data
				this.curEditId=id;															// Save id
				$("#paneId").val(o.id);														// Show  id
				$("#editorDiv").show();														// Show editor
				}
			else if (type == "ask") {														// Draw question
				o=app.doc.asks[id];															// Point at ask
				if (!o) { 																	// Invalid pane
					this.Draw("splash");													// Show splash																								
					return;																	// Quit
					}
				this.curEditId=id;															// Save id
				this.QuestionEditor(o);														// Run editor
				}
			else if (type == "rule") {														// Draw rule
				o=app.rul.rules[id];														// Point at rule
				if (!o) { 																	// Invalid pane
					this.Draw("splash");													// Show splash																								
					return;																	// Quit
					}
				this.curEditId=id;															// Save id
				this.RuleEditor(o);															// Run editor
				}
		}
	
	RuleEditor(r)																		// RULE EDITOR
	{
		var str="<div class='wm-stepEditor'>";
		str+="<table>";
		str+="<tr><td><img src='img/scalelogo.png' width='32'/></td><td><span style='font-size:30px'><b>Rule Editor</b></span><br><b</td></tr>";	
		str+="<tr><td colspan='2'><br></td></tr>";	
		str+="<tr><td><b>IF</b></td><td><input class='wm-is' type='text' id='ruleSub' value='"+(r.subject ? r.subject :'')+"'></td></tr>";	
		str+="<tr><td><b>IS</b></td><td>"+MakeSelect("ruleVerb",false,["Equal","Not equal","Less than","Less than or equal","Greater than","Greater than or equal"],r.verb,"",["=","!=","<","<=",">",">="])+"</td></tr>";	
		str+="<tr><td><b>TO</b></td><td><input class='wm-is' type='text' id='ruleSub' value='"+(r.trigger ? r.trigger :'')+"'></td></tr>";	
		str+="<tr><td><b>THEN&nbsp;</b></td><td>"+MakeSelect("ruleDo",false,["Show pane","Set status","Set var name"],r.do,"",["SHOW","STATUS","VAR"])+"</td></tr>";	
		str+="<tr><td><b>OF</b></td><td><input class='wm-is' type='text' id='ruleObj' value='"+(r.object ? r.object :'')+"'></td></tr>";	
		str+="<tr><td colspan='2'><br></td></tr>";	
		str+="<tr><td><b>Name</b></td><td><input class='wm-is' type='text' id='nameId' value='"+(r.name ? r.name :'')+"'></td></tr>";	
		str+="<tr><td><b>Id</b></td><td><input class='wm-is' type='text' id='RuleId' value='"+(r.id ? r.id :'')+"'></td></tr>";	
		str+="</table>";																			
		str+="</div><div style='margin-left:48px;margin-top:-15px'>";																		
		str+="<div id='saveRuleBut' class='wm-bs'>Save changes</div>&nbsp;&nbsp;";						
		str+="<img id='removeRuleBut' title='Delete this rule' style='vertical-align:-5px' src='img/trashbut.gif'></div>";	// Trash button
		$("#contentDiv").html(str);	

		$("#saveRulepBut").on("click", function() { 										// ON SAVE RULE
				var i;
				o.optionType=$("#optionType").val();	o.title=$("#title").val();								
				o.text=$("#text").val();				o.prompt=$("#text").val();									
				o.pic=$("#pic").val();					o.whyRight=$("#whyRight").val();								
				o.whyWrong=$("#whyWrong").val();		o.whyPartial=$("#whyPartial").val();	
				o.fontSize=$("#fontSize").val();		o.numTries=$("#numTries").val();	
				o.skip=$("#skip").val();				ask.name=$("#askName").val();
				ask.id=$("#askId").val();
				for (i=0;i<o.options.length;++i) 	o.options[i]=$("#idr"+i).val();			// Get options
				$('#asksBut').find(":selected").text(ask.id+" - "+ask.name);				// Rename pulldown			
				$("#asksBut")[0].selectedIndex=0;											// Clear selection
				Sound("ding");																// Ding sound
				_this.Draw("splash");														// Show splash																								
				});
		
		$("#removeRuleBut").on("click", function() { 										// ON REMOVE RULE
				ConfirmBox("Are you sure?","This will remove this question from your course.", ()=> {	// If sure
				app.doc.asks.splice($('#asksBut')[0].selectedIndex-1,1);					// Remove from rules
				$('#asksBut').find(":selected").remove();									// Remove from pulldown			
				$("#asksBut")[0].selectedIndex=0;											// Clear selection
				Sound("delete");															// Delete sound
				_this.Draw("splash");														// Show splash																								
				});
			});

}

	QuestionEditor(ask) 																	// ASK STEP EDITOR
	{
		var i;
		var o=$.parseJSON(ask.step);													// Convert to obj
		var _this=this;																	// Save context		
		var str="<div class='wm-stepEditor'><table style='font-size:12px'>";
		str+="<tr><td><img src='img/scalelogo.png' width='32'/></td><td><span style='font-size:30px'><b>Question Editor</b></span><br><br><b</td></tr>";	
		str+="<tr><td><b>Question name</b></td><td><input class='wm-is' type='text' id='askName' value='"+(ask.name ? ask.name :'')+"'></td></tr>";	// Get setting
		str+="<tr><td><b>Type</b></td><td>"+MakeSelect("optionType",false,["radio","checkbox","cloze","slider","draw","findtime","write","notes","match","sort"],o.optionType)+"</td></tr>";	// Get setting
		str+="<tr><td><b>Title</b></td><td><input class='wm-is' type='text' id='title' value='"+(o.title ? o.title :'')+"'></td></tr>";	// Get setting
		str+="<tr><td><b>Text</b></td><td><textarea class='wm-is' id='text'>"+(o.text ? o.text :'')+"</textarea></td></tr>";	// Get setting
		str+="<tr><td><b>Prompt</b></td><td><textarea class='wm-is' id='prompt'>"+(o.prompt ? o.prompt :'')+"</textarea></td></tr>";	// Get setting
		str+="<tr><td><b>Image</b></td><td><input class='wm-is' type='text' id='pic' value='"+(o.pic ? o.pic :'')+"'></td></tr>";	// Get setting
		str+="<tr><td><b>If right answer</b></td><td><textarea class='wm-is' id='whyRight'>"+(o.whyRight ? o.whyRight :'')+"</textarea></td></tr>";	// Get setting
		str+="<tr><td><b>If wrong answer</b></td><td><textarea class='wm-is' id='whyWrong'>"+(o.whyWrong ? o.whyWrong :'')+"</textarea></td></tr>";	// Get setting
		str+="<tr><td><b>If partial answer</b>&nbsp;</td><td><textarea class='wm-is' id='whyPartial'>"+(o.whyPartial ? o.whyPartial :'')+"</textarea></td></tr>";	// Get setting
		str+="<tr><td><b>Number of tries</b></td><td><input class='wm-is' type='text' id='numTries' value='"+(o.numTries ? o.numTries :'')+"'></td></tr>";	// Get setting
		str+="<tr><td><b>Allow skipping</b></td><td>"+MakeSelect("skip",false,["true","false"],o.skip)+"</td></tr>";	// Get setting
		str+="<tr><td><b>Font size</b></td><td><input class='wm-is' type='text' id='fontSize' value='"+(o.fontSize ? o.fontSize :'Default (12)')+"'></td></tr>";	// Get setting
		str+="<tr><td><b>Id</b></td><td><input class='wm-is' type='text' id='askId' value='"+(ask.id ? ask.id :'')+"'></td></tr>";	// Get setting
		str+="<tr><td colspan=2><p><hr></p></td></tr>";
		str+="<tr><td><b>Options</b></td><td><dl id='optionsTable'>";
		if (o.options) {
			str+="";
			for (i=0;i<o.options.length;++i) {
				str+="<dt id='ido"+i+"'style='height:28px'><input class='wm-is' type='text' id='idr"+i+"' value='"+(o.options[i] ? o.options[i] :'')+"'>"; 	// Add option
				str+="&nbsp;&nbsp;&nbsp;&nbsp;&uarr;&darr;&nbsp";																			// Add arrows
				str+="&nbsp;&nbsp;&nbsp;<img id='idd"+i+"' style='vertical-align:middle;cursor:pointer' src='img/trashbut.gif'</dt>"
				}
			}		
		str+="</dl></td></tr></table>";																			
		str+="<div style='text-align:center'><div id='addNewOptionBut' class='wm-bs'>Add new option</div></div>";	
		str+="</div><div style='margin-left:48px;margin-top:-15px'>";																		
		str+="<div id='saveStepBut' class='wm-bs'>Save changes</div>&nbsp;&nbsp;";						
		str+="<img id='removeStepBut' title='Delete this question' style='vertical-align:-5px' src='img/trashbut.gif'></div>";	// Trash button
		$("#contentDiv").html(str);	
		$("#optionsTable").sortable();
	
		$("#optionsTable").on("sortstop", function(e, ui) {									// If sorted
			var v=$("#optionsTable").sortable("toArray");									// Get new order
 			for (i=0;i<v.length-1;++i)														// For each option, less add but
 				o.options[i]=$("#idr"+v[i].substr(3)).val();								// Reorder array
 			});
		
		 if (o.options)																		// If options set
			for (i=0;i<o.options.length;++i) {												// For each option
				 $("#idd"+i).on("click", function() { 										// Extract value	
					var id=$(this)[0].id.substr(3);											// Extract id
					$("#ido"+id).remove();													// Remove option from menu
					Sound("delete");														// Delete sound
					});
				}
	
		$("#addNewOptionBut").on("click", function() { 										// ON ADD NEW OPTION	
			if (!o.options)	o.options=[];													// First one, so alloc array
			o.options.push("");																// Add new option
			var i=o.options.length-1;														// Index	
			var str="<dt id='ido"+i+"'style='height:28px'><input class='wm-is' type='text' id='idr"+i+"' value=''>"; 	
			str+="&nbsp;&nbsp;&nbsp;&nbsp;&uarr;&darr;&nbsp";														
			str+="&nbsp;&nbsp;&nbsp;<img id='idd"+i+"' style='vertical-align:middle;cursor:pointer' src='img/trashbut.gif'</dt>";
			$("#optionsTable").append(str);													// Add line to table
			Sound("click");																	// Delete sound
			
			$("#idd"+i).on("click", function() { 											// ADD TRASH HANDLER	
					var id=$(this)[0].id.substr(3);											// Extract id
					o.options.splice(id,1);													// Remove from step
					$("#ido"+id).remove();													// Remove option from menu
					Sound("delete");														// Delete sound
					});
			});

		$("#saveStepBut").on("click", function() { 											// ON SAVE STEP
				var i;
				o.optionType=$("#optionType").val();	o.title=$("#title").val();								
				o.text=$("#text").val();				o.prompt=$("#text").val();									
				o.pic=$("#pic").val();					o.whyRight=$("#whyRight").val();								
				o.whyWrong=$("#whyWrong").val();		o.whyPartial=$("#whyPartial").val();	
				o.fontSize=$("#fontSize").val();		o.numTries=$("#numTries").val();	
				o.skip=$("#skip").val();				ask.name=$("#askName").val();
				ask.id=$("#askId").val();
				for (i=0;i<o.options.length;++i) 	o.options[i]=$("#idr"+i).val();			// Get options
				ask.step=JSON.stringify(o);													// Copy at JSON string
				$('#asksBut').find(":selected").text(ask.id+" - "+ask.name);				// Rename pulldown			
				$("#asksBut")[0].selectedIndex=0;											// Clear selection
				Sound("ding");																// Ding sound
				_this.Draw("splash");														// Show splash																								
				});
		
		$("#removeStepBut").on("click", function() { 										// ON REMOVE STEP
				ConfirmBox("Are you sure?","This will remove this question from your course.", ()=> {	// If sure
				app.doc.asks.splice($('#asksBut')[0].selectedIndex-1,1);					// Remove from rules
				$('#asksBut').find(":selected").remove();									// Remove from pulldown			
				$("#asksBut")[0].selectedIndex=0;											// Clear selection
				Sound("delete");															// Delete sound
				_this.Draw("splash");														// Show splash																								
				});
			});
		}																					// EditStep() closure
	}																						// Class closure



////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// TREE  
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	class Tree {

		constructor()  																	// CONSTRUCTOR
		{
			this.Init();																	// Init tree
		}

		Init(id) 																			// INIT TREE
		{
			var _this=this;																	// Save context		
			var o=app.doc.lobs[0];															// Point at root												
			if (!o)	return;																	// If invalid, quit
			var str="<ul><li class='parent active'><a id='tr-"+o.id+"'>"+o.name+"</a></li>"; // Add root tree node
	for (var i=2;i<9;++i)	str+="<ul><li><a id='tr--"+i+"'>Week "+i+"</a></li></ul>";
			$("#treeDiv").html(str+"</ul>");												// Add to tree div
			this.AddChildren($("#tr-"+o.id),0);												// Add children to tree
			$("#tr-"+o.id).parent().children('ul').slideToggle('fast');            			// Open course
			$("[id^=tr-]").draggable( {	revert:true });										// Make lines draggable to change parent
			$("[id^=tr-]").droppable( {														// Make lines droppable to change parent
				drop: function(e,ui) {														// On drop
					var mode=e.shiftKey ? "shift" : "move";									// Move or shift
					app.doc.ChangeOrder(ui.draggable[0].id.substr(3),e.target.id.substr(3),mode); // Rearrange
					_this.Init(ui.draggable[0].id.substr(3));								// Re-init tree	
					Sound("ding");															// Ding
					}
			});




			if (id != undefined) this.Open(id);	

			$('.wm-tree li > a').on("click", function(e) {									// ON CLICK OF NODE TEXT
				_this.handleTreeClick($(this),e);  											// Handle
				});      
		
		}
/*
	Init2(id) 																			// INIT TREE
		{
			var _this=this;																	// Save context		
			var str="<ul><li class='parent active'><a id='tr-'"+o.id+"'>"+o.name+"</a></li>";	// Root tree node

				//	str+="<ul><li><a id='tr--2'>Week 2</a></ul>";	str+="<ul><li><a id='tr--3'>Week 3</a></ul>";	str+="<ul><li><a id='tr--4'>Week 4</a></ul>";	str+="<ul><li><a id='tr--5'>Week 5</a></ul>"; str+="<ul><li><a id='tr--6'>Week 6</a></ul>";	str+="<ul><li><a id='tr--7'>Week 7</a></ul>";	str+="<ul><li><a id='tr--8'>Week 8</a></ul>";
			$("#treeDiv").html(str+"</ul>");												// Add to tree div
			this.AddChildren($("#tr-"+o.id),0);												// Add children to tree
			$("#tr-10").parent().children('ul').slideToggle('fast');            			// Open course
			$("[id^=tr-]").draggable( {	revert:true });										// Make lines draggable to change parent
			$("[id^=tr-]").droppable( {														// Make lines droppable to change parent
				drop: function(e,ui) {														// On drop
					var mode=e.shiftKey ? "shift" : "move";									// Move or shift
					app.doc.ChangeOrder(ui.draggable[0].id.substr(3),e.target.id.substr(3),mode); // Rearrange
					_this.Init(ui.draggable[0].id.substr(3));								// Re-init tree	
					Sound("ding");															// Ding
					}
			});

*/
		Open(id)																		// OPEN TREE AT ID
		{
			var i;
			var row=$("#tr-"+id);															// Trace row
			var par=row.parent();															// Point at previous line
			$('.wm-tree li a').each( function() {                          					// For each line
				$(this).css({"color":"#000","font-weight":"normal"});      					// Normal
				}); 
			row.css({"color":"#009900","font-weight":"bold"});          					// Bold and green   
			for (i=0;i<20;++i) {															// Iterate upwards
				if ($(par).attr("class") == "wm-tree")	break;								// Quit at top of tree
				if ($(par).attr("class") == "parent") {										// Has children
					par.addClass('active');                         						// Active class on 
					par.children('ul').slideToggle('fast');            						// Slide into place
					}
				par=par.parent();															// Up a level
				}
		}

	handleTreeClick(row, e)																// HANDLE TREE CLICK
	{
		if (e.offsetX < 12) {                                         				  		// In icon
			row.parent().toggleClass('active');                         					// Toggle active class on or off
			row.parent().children('ul').slideToggle('fast');            					// Slide into place
			}
		else{																				// In text
			$('.wm-tree li a').each( function() {                          					// For each line
				$(this).css({"color":"#000","font-weight":"normal"});      					// Normal
				}); 
			row.css({"color":"#009900","font-weight":"bold"});          					// Bold and green   
			this.curRow=row;																// Save row
			this.curPaneId=e.target.id.substr(3);											// Save pane id
			app.con.Draw("pane",this.curPaneId);											// Show pane
			}
		}

	AddChildren(row, id) 																// ADD CHILDREN TO TREE RECURSIVELY
	{
		var i,o,oo;
		if (id < 0)	return;																	// Invalid index
		var o=app.doc.lobs[id];																// Point at parent												
		if (!o)	return;																		// If invalid, quit
		if (!o.children)	return;															// Quit if no children
		var str="<ul style='display:none'>";												// Wrapper
		for (i=0;i<o.children.length;++i) {													// For each child
			str+="<li";																		// Start row
			oo=app.doc.lobs[o.kids[i]];														// Point at child lob via index
			if (oo.children.length)	str+=" class='parent'"									// Add parent if it has children
			str+="><a id='tr-"+oo.id+"'>"+oo.name;											// Add index and name
			str+"</a></li>";																// Add label
			}
		row.after(str+"</ul>");																// Add to tree
		for (i=0;i<o.children.length;++i) 													// For each child
			this.AddChildren($("#tr-"+o.children[i]),o.kids[i]);							// Recurse
		}
}																						// Class closure

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function ConfirmBox(title, content, callback)										// CONFIRMATION BOX
	{
		Sound("ding");																		// Ding sound
		$("#confirmBoxDiv").remove();														// Remove 
		$("body").append("<div class='wm-confirm' id='confirmBoxDiv'></div>");														
		var str="<img src='img/scalelogo.png' width='32' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:18px; color:#666'><b>"+title+"</b></span><br>";
		str+="<p>"+content+"<p>";
		str+="<div style='float:right'><div id='confirmOK' class='wm-bs'>OK</div>";
		str+="<div id='confirmCancel' class='wm-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);	
	
		$("#confirmOK").on("click", function() {											// ON OK BUT
				$("#confirmBoxDiv").remove();												// Remove 
				if (callback)	callback();													// If callback defines, run it
				});

		$("#confirmCancel").on("click", function() {										// ON CANCEL BUT
				$("#confirmBoxDiv").remove();												// Remove 
				Sound("delete");															// Delete sound
				});
	}

	function MakeSelect(id, multi, items, sel, extra, values)				// CREATE HTML SELECT
	{
		var	str="<select class='wm-is' style='width:200px' id='"+id+"'";		// Header
		if (multi)																// Multi select
			str+="multiple='multiple' size='"+multi+"'";						// Add flag
		if (extra)																// If extra param
			str+=extra;															// Add them
		str+=">";																// End header
		for (i=0;i<items.length;++i) {											// For each option
			str+="<option";														// Add tag
			if (sel == items[i])												// If selected
				str+=" selected='selected'"										// Add tag
			if (values && values[i])											// If has a value
				str+=" value='"+values[i]+"'";									// Add it
			str+=">"+items[i]+"</option>";										// End option
			}	
		return str+"</select>";													// End select				
	}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function CopyToClipboard(text) 											// COPY TEXT TO CLIP BOARD
	{
  		var textArea = document.createElement("textarea");
		textArea.style.position = 'fixed';
  		textArea.style.top=textArea.style.left = 0;
  		textArea.style.width=textArea.style.height = '2em';
  		textArea.style.padding = 0;
		textArea.style.border=textArea.style.outline=textArea.style.boxShadow = 'none';
		textArea.style.background = 'transparent';
		textArea.value = text;
		document.body.appendChild(textArea);
		textArea.select();
		try {
			if (document.execCommand('copy'))
				Sound("ding");
			else
				Sound("delete");
			} catch (err) {
				Sound("delete");
				}
		document.body.removeChild(textArea);
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (!snd.canPlayType("audio/mpeg") || (snd.canPlayType("audio/mpeg") == "maybe")) 
			snd=new Audio("img/"+sound+".ogg");									// Use ogg
		else	
			snd=new Audio("img/"+sound+".mp3");									// Use mp3
		if (!mute)																// If not initing or muting	
			snd.play();															// Play sound
	}

</script>
</body></html>
